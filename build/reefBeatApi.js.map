{
  "version": 3,
  "sources": ["../src/reefBeatApi.ts"],
  "sourcesContent": ["import axios from \"axios\";\nimport json2iob from \"json2iob\";\nimport { IoBrokerHelper } from \"./IoBrokerHelper\";\nimport { IReefBeat } from \"./types\";\n\nexport class ReefBeatApi {\n\tprotected adapter: IReefBeat;\n\tprotected ip: string;\n\tprotected baseUrl: string;\n\tprotected secure: boolean;\n\tprotected localCapabilities: string[];\n\tprotected headers: { [key: string]: string } = {};\n\tprotected json2iob: json2iob;\n\tprotected token!: string;\n\tprotected tokenExpires: number = 0;\n\tprotected helper: IoBrokerHelper;\n\n\tconstructor(ip: string, secure: boolean = false, adapter: IReefBeat, helper: IoBrokerHelper) {\n\t\tthis.ip = ip;\n\t\tthis.secure = secure;\n\t\tthis.baseUrl = (secure ? \"https://\" : \"http://\") + ip;\n\t\tthis.adapter = adapter;\n\t\tthis.json2iob = new json2iob(adapter);\n\t\tthis.localCapabilities = [\"device-info\", \"mode\", \"dashboard\"];\n\t\tthis.helper = helper;\n\t}\n\n\t// GET Request\n\tpublic async httpGetAsync(path: string, isCloud: boolean = false): Promise<any | null> {\n\t\tconst url = isCloud ? path : this.baseUrl + \"/\" + path;\n\n\t\ttry {\n\t\t\tthis.adapter.log.info(`GET ${url}`);\n\n\t\t\t// axios verwendet 'data' f\u00FCr den Response-Body\n\t\t\tconst resp = await axios.get(url, { headers: this.headers });\n\t\t\treturn resp.data;\n\t\t} catch (ex: any) {\n\t\t\tconst status = ex.response ? ex.response.status : \"N/A\";\n\t\t\tthis.adapter.log.error(`GET ${path} failed (Status: ${status}): ${ex.message}`);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t// POST/PUT Request (verwendet axios)\n\tprotected async httpSendAsync(path: string, payload: any, method: \"POST\" | \"PUT\"): Promise<boolean> {\n\t\tconst url = this.baseUrl + path;\n\t\tthis.adapter.log.debug(\"Calling \" + url);\n\t\ttry {\n\t\t\tthis.adapter.log.debug(`${method} ${url} Payload: ${JSON.stringify(payload)}`);\n\n\t\t\tawait axios({\n\t\t\t\tmethod: method,\n\t\t\t\turl: url,\n\t\t\t\theaders: {\n\t\t\t\t\t...this.headers,\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t},\n\t\t\t\tdata: payload,\n\t\t\t});\n\n\t\t\treturn true;\n\t\t} catch (ex: any) {\n\t\t\tconst status = ex.response ? ex.response.status : \"N/A\";\n\t\t\tthis.adapter.log.error(`${method} ${path} failed (Status: ${status}): ${ex.message}`);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tprotected async getDataAsync<T = any>(sourceName: string): Promise<T | null> {\n\t\tconst result = await this.httpGetAsync(sourceName);\n\t\tthis.adapter.log.debug(`Data from ${sourceName}: ${JSON.stringify(result)}`);\n\n\t\treturn result;\n\t}\n\n\tprotected async getAndSetDataAsync(sourceName: string): Promise<void> {\n\t\tconst result = await this.getDataAsync(sourceName);\n\t\tthis.json2iob.parse(this.constructor.name + \".\" + sourceName, result, { forceIndex: true });\n\t\tthis.helper.ensureStateAsync(\n\t\t\tthis.constructor.name + \".\" + sourceName + \"._Refresh\",\n\t\t\t\"Refresh data\",\n\t\t\t\"boolean\",\n\t\t\t\"button\",\n\t\t\ttrue,\n\t\t\ttrue,\n\t\t);\n\t}\n\n\tpublic async pollBasicDataAsync(): Promise<void> {\n\t\tconst requests = this.localCapabilities.map(async (capability) => {\n\t\t\tthis.getAndSetDataAsync(capability);\n\t\t});\n\n\t\tawait Promise.all(requests);\n\t}\n\n\tpublic async getAquariumAsync(ip: string, username: string, password: string): Promise<void> {\n\t\tif (!this.token || Date.now() >= this.tokenExpires) {\n\t\t\tawait this.connectAsync(ip, username, password);\n\n\t\t\tconst result = await this.httpGetAsync(\"https://cloud.reef-beat.com/aquarium\", true);\n\t\t\tthis.adapter.log.info(\"Aquarium replay: \" + JSON.stringify(result));\n\t\t\tthis.json2iob.parse(this.constructor.name + \".aquariums\", result, { forceIndex: true });\n\t\t}\n\t}\n\n\tpublic async pollCloudAsync(ip: string, username: string, password: string): Promise<void> {\n\t\tif (!this.token || Date.now() >= this.tokenExpires) {\n\t\t\tawait this.connectAsync(ip, username, password);\n\t\t}\n\n\t\tconst result = await this.httpGetAsync(\"https://cloud.reef-beat.com/reef-wave/library\", true);\n\t\tconst result2 = await this.httpGetAsync(\"https://cloud.reef-beat.com/device\", true);\n\t\tconst result3 = await this.httpGetAsync(\"https://cloud.reef-beat.com/aquarium\", true);\n\n\t\tthis.adapter.log.info(\"Cloud replay: \" + JSON.stringify(result));\n\t\tthis.adapter.log.info(\"Cloud replay: \" + JSON.stringify(result2));\n\t\tthis.adapter.log.info(\"Cloud replay: \" + JSON.stringify(result3));\n\t}\n\n\tprivate async connectAsync(ip: string, username: string, password: string): Promise<string | null> {\n\t\ttry {\n\t\t\tconst url = `https://${ip}/oauth/token`;\n\n\t\t\t// Exakt derselbe Basic-Auth-Header wie im Python/C#-Code\n\t\t\tconst headers = {\n\t\t\t\tAuthorization: \"Basic Z0ZqSHRKcGE6Qzlmb2d3cmpEV09SVDJHWQ==\",\n\t\t\t\t\"Content-Type\": \"application/x-www-form-urlencoded\",\n\t\t\t};\n\n\t\t\t// URL-encoded payload\n\t\t\tconst payload = new URLSearchParams({\n\t\t\t\tgrant_type: \"password\",\n\t\t\t\tusername,\n\t\t\t\tpassword,\n\t\t\t});\n\n\t\t\tconst response = await fetch(url, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders,\n\t\t\t\tbody: payload.toString(),\n\t\t\t});\n\n\t\t\tthis.adapter.log.info(\"HTTP Status:\" + response.status);\n\n\t\t\tconst text = await response.text();\n\t\t\tthis.adapter.log.info(\"Response body:\\n\" + text);\n\n\t\t\tif (!response.ok) {\n\t\t\t\tthis.adapter.log.error(\"Fehlerhafte Antwort vom Server.\");\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// JSON parsen\n\t\t\tconst json = JSON.parse(text);\n\t\t\tconst token = json[\"access_token\"];\n\t\t\tif (!token) {\n\t\t\t\tthis.adapter.log.error(\"Kein access_token im Response.\");\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst now = Date.now();\n\t\t\tthis.token = json[\"access_token\"];\n\t\t\tthis.tokenExpires = now + json[\"expires_in\"] * 1000; // timestamp in ms\n\t\t\tthis.headers[\"Authorization\"] = `Bearer ${this.token}`;\n\n\t\t\tthis.adapter.log.info(\"Access Token:\" + token);\n\t\t\treturn token;\n\t\t} catch (err) {\n\t\t\tthis.adapter.log.error(\"ConnectAsync Fehler:\" + err);\n\t\t\treturn null;\n\t\t}\n\t}\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAkB;AAClB,sBAAqB;AAId,MAAM,YAAY;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA,UAAqC,CAAC;AAAA,EACtC;AAAA,EACA;AAAA,EACA,eAAuB;AAAA,EACvB;AAAA,EAEV,YAAY,IAAY,SAAkB,OAAO,SAAoB,QAAwB;AAC5F,SAAK,KAAK;AACV,SAAK,SAAS;AACd,SAAK,WAAW,SAAS,aAAa,aAAa;AACnD,SAAK,UAAU;AACf,SAAK,WAAW,IAAI,gBAAAA,QAAS,OAAO;AACpC,SAAK,oBAAoB,CAAC,eAAe,QAAQ,WAAW;AAC5D,SAAK,SAAS;AAAA,EACf;AAAA;AAAA,EAGA,MAAa,aAAa,MAAc,UAAmB,OAA4B;AACtF,UAAM,MAAM,UAAU,OAAO,KAAK,UAAU,MAAM;AAElD,QAAI;AACH,WAAK,QAAQ,IAAI,KAAK,OAAO,GAAG,EAAE;AAGlC,YAAM,OAAO,MAAM,aAAAC,QAAM,IAAI,KAAK,EAAE,SAAS,KAAK,QAAQ,CAAC;AAC3D,aAAO,KAAK;AAAA,IACb,SAAS,IAAS;AACjB,YAAM,SAAS,GAAG,WAAW,GAAG,SAAS,SAAS;AAClD,WAAK,QAAQ,IAAI,MAAM,OAAO,IAAI,oBAAoB,MAAM,MAAM,GAAG,OAAO,EAAE;AAC9E,aAAO;AAAA,IACR;AAAA,EACD;AAAA;AAAA,EAGA,MAAgB,cAAc,MAAc,SAAc,QAA0C;AACnG,UAAM,MAAM,KAAK,UAAU;AAC3B,SAAK,QAAQ,IAAI,MAAM,aAAa,GAAG;AACvC,QAAI;AACH,WAAK,QAAQ,IAAI,MAAM,GAAG,MAAM,IAAI,GAAG,aAAa,KAAK,UAAU,OAAO,CAAC,EAAE;AAE7E,gBAAM,aAAAA,SAAM;AAAA,QACX;AAAA,QACA;AAAA,QACA,SAAS;AAAA,UACR,GAAG,KAAK;AAAA,UACR,gBAAgB;AAAA,QACjB;AAAA,QACA,MAAM;AAAA,MACP,CAAC;AAED,aAAO;AAAA,IACR,SAAS,IAAS;AACjB,YAAM,SAAS,GAAG,WAAW,GAAG,SAAS,SAAS;AAClD,WAAK,QAAQ,IAAI,MAAM,GAAG,MAAM,IAAI,IAAI,oBAAoB,MAAM,MAAM,GAAG,OAAO,EAAE;AACpF,aAAO;AAAA,IACR;AAAA,EACD;AAAA,EAEA,MAAgB,aAAsB,YAAuC;AAC5E,UAAM,SAAS,MAAM,KAAK,aAAa,UAAU;AACjD,SAAK,QAAQ,IAAI,MAAM,aAAa,UAAU,KAAK,KAAK,UAAU,MAAM,CAAC,EAAE;AAE3E,WAAO;AAAA,EACR;AAAA,EAEA,MAAgB,mBAAmB,YAAmC;AACrE,UAAM,SAAS,MAAM,KAAK,aAAa,UAAU;AACjD,SAAK,SAAS,MAAM,KAAK,YAAY,OAAO,MAAM,YAAY,QAAQ,EAAE,YAAY,KAAK,CAAC;AAC1F,SAAK,OAAO;AAAA,MACX,KAAK,YAAY,OAAO,MAAM,aAAa;AAAA,MAC3C;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACD;AAAA,EACD;AAAA,EAEA,MAAa,qBAAoC;AAChD,UAAM,WAAW,KAAK,kBAAkB,IAAI,OAAO,eAAe;AACjE,WAAK,mBAAmB,UAAU;AAAA,IACnC,CAAC;AAED,UAAM,QAAQ,IAAI,QAAQ;AAAA,EAC3B;AAAA,EAEA,MAAa,iBAAiB,IAAY,UAAkB,UAAiC;AAC5F,QAAI,CAAC,KAAK,SAAS,KAAK,IAAI,KAAK,KAAK,cAAc;AACnD,YAAM,KAAK,aAAa,IAAI,UAAU,QAAQ;AAE9C,YAAM,SAAS,MAAM,KAAK,aAAa,wCAAwC,IAAI;AACnF,WAAK,QAAQ,IAAI,KAAK,sBAAsB,KAAK,UAAU,MAAM,CAAC;AAClE,WAAK,SAAS,MAAM,KAAK,YAAY,OAAO,cAAc,QAAQ,EAAE,YAAY,KAAK,CAAC;AAAA,IACvF;AAAA,EACD;AAAA,EAEA,MAAa,eAAe,IAAY,UAAkB,UAAiC;AAC1F,QAAI,CAAC,KAAK,SAAS,KAAK,IAAI,KAAK,KAAK,cAAc;AACnD,YAAM,KAAK,aAAa,IAAI,UAAU,QAAQ;AAAA,IAC/C;AAEA,UAAM,SAAS,MAAM,KAAK,aAAa,iDAAiD,IAAI;AAC5F,UAAM,UAAU,MAAM,KAAK,aAAa,sCAAsC,IAAI;AAClF,UAAM,UAAU,MAAM,KAAK,aAAa,wCAAwC,IAAI;AAEpF,SAAK,QAAQ,IAAI,KAAK,mBAAmB,KAAK,UAAU,MAAM,CAAC;AAC/D,SAAK,QAAQ,IAAI,KAAK,mBAAmB,KAAK,UAAU,OAAO,CAAC;AAChE,SAAK,QAAQ,IAAI,KAAK,mBAAmB,KAAK,UAAU,OAAO,CAAC;AAAA,EACjE;AAAA,EAEA,MAAc,aAAa,IAAY,UAAkB,UAA0C;AAClG,QAAI;AACH,YAAM,MAAM,WAAW,EAAE;AAGzB,YAAM,UAAU;AAAA,QACf,eAAe;AAAA,QACf,gBAAgB;AAAA,MACjB;AAGA,YAAM,UAAU,IAAI,gBAAgB;AAAA,QACnC,YAAY;AAAA,QACZ;AAAA,QACA;AAAA,MACD,CAAC;AAED,YAAM,WAAW,MAAM,MAAM,KAAK;AAAA,QACjC,QAAQ;AAAA,QACR;AAAA,QACA,MAAM,QAAQ,SAAS;AAAA,MACxB,CAAC;AAED,WAAK,QAAQ,IAAI,KAAK,iBAAiB,SAAS,MAAM;AAEtD,YAAM,OAAO,MAAM,SAAS,KAAK;AACjC,WAAK,QAAQ,IAAI,KAAK,qBAAqB,IAAI;AAE/C,UAAI,CAAC,SAAS,IAAI;AACjB,aAAK,QAAQ,IAAI,MAAM,iCAAiC;AACxD,eAAO;AAAA,MACR;AAGA,YAAM,OAAO,KAAK,MAAM,IAAI;AAC5B,YAAM,QAAQ,KAAK,cAAc;AACjC,UAAI,CAAC,OAAO;AACX,aAAK,QAAQ,IAAI,MAAM,gCAAgC;AACvD,eAAO;AAAA,MACR;AAEA,YAAM,MAAM,KAAK,IAAI;AACrB,WAAK,QAAQ,KAAK,cAAc;AAChC,WAAK,eAAe,MAAM,KAAK,YAAY,IAAI;AAC/C,WAAK,QAAQ,eAAe,IAAI,UAAU,KAAK,KAAK;AAEpD,WAAK,QAAQ,IAAI,KAAK,kBAAkB,KAAK;AAC7C,aAAO;AAAA,IACR,SAAS,KAAK;AACb,WAAK,QAAQ,IAAI,MAAM,yBAAyB,GAAG;AACnD,aAAO;AAAA,IACR;AAAA,EACD;AACD;",
  "names": ["json2iob", "axios"]
}
