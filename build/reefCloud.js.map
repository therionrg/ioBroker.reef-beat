{
  "version": 3,
  "sources": ["../src/reefCloud.ts"],
  "sourcesContent": ["import { IoBrokerHelper } from \"./IoBrokerHelper\";\nimport { ReefBeatApi } from \"./reefBeatApi\";\nimport { IReefBeat } from \"./types\";\n\nexport class ReefCloud extends ReefBeatApi {\n\tprivate username: string;\n\tprivate password: string;\n\tprivate refreshToken?: string;\n\n\tconstructor(ip: string, adapter: IReefBeat, helper: IoBrokerHelper, username: string, password: string) {\n\t\tsuper(ip, false, adapter, helper);\n\t\tthis.username = username;\n\t\tthis.password = password;\n\t\tthis.adapter.log.info(\"ReefCloud initialized.\");\n\t}\n\n\tpublic async pollCloudAsync(sourceName: string): Promise<void> {\n\t\tif (!(await this.ensureTokenAsync())) {\n\t\t\tthis.adapter.log.error(\"Cannot ensure valid token. Aborting pollCloudAsync.\");\n\t\t\treturn;\n\t\t}\n\n\t\tthis.adapter.log.info(\"Start cloud polling for \" + sourceName + \"...\");\n\n\t\tif (sourceName) {\n\t\t\tif (sourceName.endsWith(\"s\")) {\n\t\t\t\tsourceName = sourceName.slice(0, -1);\n\t\t\t}\n\n\t\t\tthis.getAndSetDataAsync(sourceName);\n\t\t} else {\n\t\t\tthis.getAndSetDataAsync(\"aquarium\");\n\t\t\tthis.getAndSetDataAsync(\"device\");\n\t\t\tthis.getAndSetDataAsync(\"reef-wave/library\");\n\t\t}\n\n\t\tthis.adapter.log.info(\"Finished cloud polling...\");\n\t}\n\n\tprivate async connectAsync(): Promise<boolean> {\n\t\tconst payload = new URLSearchParams({\n\t\t\tgrant_type: \"password\",\n\t\t\tusername: this.username,\n\t\t\tpassword: this.password,\n\t\t});\n\n\t\treturn await this.requestTokenAsync(payload);\n\t}\n\n\tprivate async refreshTokenAsync(): Promise<boolean> {\n\t\tif (!this.refreshToken) {\n\t\t\tthis.adapter.log.warn(\"No refresh token available.\");\n\t\t\treturn false;\n\t\t}\n\n\t\tconst payload = new URLSearchParams({\n\t\t\tgrant_type: \"refresh_token\",\n\t\t\trefresh_token: this.refreshToken,\n\t\t});\n\n\t\treturn await this.requestTokenAsync(payload);\n\t}\n\n\tprivate async requestTokenAsync(payload: URLSearchParams): Promise<boolean> {\n\t\ttry {\n\t\t\tconst url = `https://${this.ip}/oauth/token`;\n\n\t\t\tconst headers = {\n\t\t\t\tAuthorization: \"Basic Z0ZqSHRKcGE6Qzlmb2d3cmpEV09SVDJHWQ==\",\n\t\t\t\t\"Content-Type\": \"application/x-www-form-urlencoded\",\n\t\t\t};\n\n\t\t\tconst response = await fetch(url, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders,\n\t\t\t\tbody: payload.toString(),\n\t\t\t});\n\n\t\t\tconst text = await response.text();\n\n\t\t\tif (!response.ok) {\n\t\t\t\tthis.adapter.log.error(\"Token Request failed:\\n\" + text);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst json = JSON.parse(text);\n\n\t\t\t// Tokens speichern\n\t\t\tthis.token = json[\"access_token\"];\n\t\t\tthis.tokenExpires = Date.now() + json[\"expires_in\"] * 1000;\n\n\t\t\tif (json[\"refresh_token\"]) {\n\t\t\t\tthis.refreshToken = json[\"refresh_token\"];\n\t\t\t}\n\n\t\t\tthis.headers[\"Authorization\"] = `Bearer ${this.token}`;\n\t\t\tthis.adapter.log.info(\"Successfully received access token.\");\n\t\t\treturn true;\n\t\t} catch (err) {\n\t\t\tthis.adapter.log.error(\"Token Request Error:\" + err);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tprivate async ensureTokenAsync(): Promise<boolean> {\n\t\tconst now = Date.now();\n\t\tif (this.token) {\n\t\t\tif (this.token && now < this.tokenExpires - 30000) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (this.refreshToken) {\n\t\t\t\tconst ok = await this.refreshTokenAsync();\n\t\t\t\tif (ok) return true;\n\n\t\t\t\tthis.adapter.log.warn(\"Refresh token expired or invalid.\");\n\t\t\t}\n\t\t}\n\n\t\tif (!(await this.connectAsync())) {\n\t\t\tthis.adapter.log.error(\"New authetification failed. Check username and/or password.\");\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
