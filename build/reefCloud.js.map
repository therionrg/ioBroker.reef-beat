{
  "version": 3,
  "sources": ["../src/reefCloud.ts"],
  "sourcesContent": ["import { IoBrokerHelper } from \"./IoBrokerHelper\";\nimport { ReefBeatApi } from \"./reefBeatApi\";\nimport { IReefBeat } from \"./types\";\n\nexport class ReefCloud extends ReefBeatApi {\n\tprivate username: string;\n\tprivate password: string;\n\n\tconstructor(ip: string, adapter: IReefBeat, helper: IoBrokerHelper, username: string, password: string) {\n\t\tsuper(ip, false, adapter, helper);\n\t\tthis.username = username;\n\t\tthis.password = password;\n\t}\n\n\tpublic async pollCloudAsync(): Promise<void> {\n\t\tif (!this.token || Date.now() >= this.tokenExpires) {\n\t\t\tawait this.connectAsync();\n\t\t}\n\n\t\tthis.getAndSetDataAsync(\"aquarium\");\n\t\tthis.getAndSetDataAsync(\"device\");\n\t\tthis.getAndSetDataAsync(\"reef-wave/library\");\n\t}\n\n\tprivate async connectAsync(): Promise<string | null> {\n\t\ttry {\n\t\t\tconst url = `https://${this.ip}/oauth/token`;\n\n\t\t\t// Exakt derselbe Basic-Auth-Header wie im Python/C#-Code\n\t\t\tconst headers = {\n\t\t\t\tAuthorization: \"Basic Z0ZqSHRKcGE6Qzlmb2d3cmpEV09SVDJHWQ==\",\n\t\t\t\t\"Content-Type\": \"application/x-www-form-urlencoded\",\n\t\t\t};\n\n\t\t\t// URL-encoded payload\n\t\t\tconst payload = new URLSearchParams({\n\t\t\t\tgrant_type: \"password\",\n\t\t\t\tusername: this.username,\n\t\t\t\tpassword: this.password,\n\t\t\t});\n\n\t\t\tconst response = await fetch(url, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders,\n\t\t\t\tbody: payload.toString(),\n\t\t\t});\n\n\t\t\tthis.adapter.log.info(\"HTTP Status:\" + response.status);\n\n\t\t\tconst text = await response.text();\n\t\t\tthis.adapter.log.info(\"Response body:\\n\" + text);\n\n\t\t\tif (!response.ok) {\n\t\t\t\tthis.adapter.log.error(\"Fehlerhafte Antwort vom Server.\");\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// JSON parsen\n\t\t\tconst json = JSON.parse(text);\n\t\t\tconst token = json[\"access_token\"];\n\t\t\tif (!token) {\n\t\t\t\tthis.adapter.log.error(\"Kein access_token im Response.\");\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst now = Date.now();\n\t\t\tthis.token = json[\"access_token\"];\n\t\t\tthis.tokenExpires = now + json[\"expires_in\"] * 1000; // timestamp in ms\n\t\t\tthis.headers[\"Authorization\"] = `Bearer ${this.token}`;\n\n\t\t\tthis.adapter.log.info(\"Access Token:\" + token);\n\t\t\treturn token;\n\t\t} catch (err) {\n\t\t\tthis.adapter.log.error(\"ConnectAsync Fehler:\" + err);\n\t\t\treturn null;\n\t\t}\n\t}\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,yBAA4B;AAGrB,MAAM,kBAAkB,+BAAY;AAAA,EAClC;AAAA,EACA;AAAA,EAER,YAAY,IAAY,SAAoB,QAAwB,UAAkB,UAAkB;AACvG,UAAM,IAAI,OAAO,SAAS,MAAM;AAChC,SAAK,WAAW;AAChB,SAAK,WAAW;AAAA,EACjB;AAAA,EAEA,MAAa,iBAAgC;AAC5C,QAAI,CAAC,KAAK,SAAS,KAAK,IAAI,KAAK,KAAK,cAAc;AACnD,YAAM,KAAK,aAAa;AAAA,IACzB;AAEA,SAAK,mBAAmB,UAAU;AAClC,SAAK,mBAAmB,QAAQ;AAChC,SAAK,mBAAmB,mBAAmB;AAAA,EAC5C;AAAA,EAEA,MAAc,eAAuC;AACpD,QAAI;AACH,YAAM,MAAM,WAAW,KAAK,EAAE;AAG9B,YAAM,UAAU;AAAA,QACf,eAAe;AAAA,QACf,gBAAgB;AAAA,MACjB;AAGA,YAAM,UAAU,IAAI,gBAAgB;AAAA,QACnC,YAAY;AAAA,QACZ,UAAU,KAAK;AAAA,QACf,UAAU,KAAK;AAAA,MAChB,CAAC;AAED,YAAM,WAAW,MAAM,MAAM,KAAK;AAAA,QACjC,QAAQ;AAAA,QACR;AAAA,QACA,MAAM,QAAQ,SAAS;AAAA,MACxB,CAAC;AAED,WAAK,QAAQ,IAAI,KAAK,iBAAiB,SAAS,MAAM;AAEtD,YAAM,OAAO,MAAM,SAAS,KAAK;AACjC,WAAK,QAAQ,IAAI,KAAK,qBAAqB,IAAI;AAE/C,UAAI,CAAC,SAAS,IAAI;AACjB,aAAK,QAAQ,IAAI,MAAM,iCAAiC;AACxD,eAAO;AAAA,MACR;AAGA,YAAM,OAAO,KAAK,MAAM,IAAI;AAC5B,YAAM,QAAQ,KAAK,cAAc;AACjC,UAAI,CAAC,OAAO;AACX,aAAK,QAAQ,IAAI,MAAM,gCAAgC;AACvD,eAAO;AAAA,MACR;AAEA,YAAM,MAAM,KAAK,IAAI;AACrB,WAAK,QAAQ,KAAK,cAAc;AAChC,WAAK,eAAe,MAAM,KAAK,YAAY,IAAI;AAC/C,WAAK,QAAQ,eAAe,IAAI,UAAU,KAAK,KAAK;AAEpD,WAAK,QAAQ,IAAI,KAAK,kBAAkB,KAAK;AAC7C,aAAO;AAAA,IACR,SAAS,KAAK;AACb,WAAK,QAAQ,IAAI,MAAM,yBAAyB,GAAG;AACnD,aAAO;AAAA,IACR;AAAA,EACD;AACD;",
  "names": []
}
